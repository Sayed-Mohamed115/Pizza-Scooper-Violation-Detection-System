<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Pizza Store Monitor | Hygiene Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #video-canvas {
            background-color: #000;
            border-radius: 12px;
            width: 100%;
            height: auto;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .log-card {
            transition: all 0.3s ease;
            animation: slideIn 0.4s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* ÿ™ÿµŸÖŸäŸÖ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ŸÑŸÑÿ≥ÿ¨ŸÑ */
        #log-container::-webkit-scrollbar {
            height: 8px;
        }
        #log-container::-webkit-scrollbar-track {
            background: #1f2937;
        }
        #log-container::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
    </style>
</head>
<body class="bg-gray-950 text-white min-h-screen font-sans">

    <div class="container mx-auto px-4 py-6">
        <header class="flex justify-between items-center mb-6 bg-gray-900 p-6 rounded-2xl border border-gray-800">
            <div>
                <h1 class="text-2xl font-black tracking-tight text-blue-500 uppercase">Pizza Store <span class="text-white">Scooper AI</span></h1>
                <p class="text-gray-400 text-sm">Real-time Hygiene Protocol Monitoring</p>
            </div>
            <div class="flex items-center gap-8">
                <div class="text-center">
                    <p class="text-xs text-gray-500 uppercase font-bold tracking-widest">Violations</p>
                    <p id="violation-count" class="text-4xl font-black text-red-500">0</p>
                </div>
                <div class="h-10 w-px bg-gray-700"></div>
                <div id="status-indicator" class="flex items-center gap-2">
                    <span class="w-3 h-3 bg-gray-600 rounded-full" id="status-dot"></span>
                    <span id="status-text" class="text-sm font-medium text-gray-400">Offline</span>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            
            <div class="lg:col-span-3 space-y-4">
                <div class="relative overflow-hidden rounded-xl border-2 border-gray-800">
                    <canvas id="video-canvas"></canvas>
                    
                    <div id="violation-alert" class="hidden absolute inset-0 pointer-events-none border-8 border-red-600 animate-pulse flex items-center justify-center">
                        <div class="bg-red-600 text-white px-8 py-3 rounded-full font-black text-2xl shadow-2xl">
                            ‚ö†Ô∏è PROTOCOL VIOLATION
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 p-2">
                    <button id="start-btn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
                        START MONITORING
                    </button>
                    <button id="stop-btn" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95">
                        STOP FEED
                    </button>
                </div>
            </div>

            <div class="lg:col-span-1 space-y-6">
                <div class="bg-gray-900 p-5 rounded-xl border border-gray-800 shadow-xl">
                    <h3 class="text-gray-400 text-xs font-bold uppercase mb-4 tracking-wider">System Diagnostics</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between">
                            <span class="text-gray-500 text-sm">Model:</span>
                            <span class="text-blue-400 font-mono text-sm">YOLO12m-v2</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="text-gray-500 text-sm">Active Objects:</span>
                            <span id="obj-count" class="text-green-400 font-mono text-sm">0</span>
                        </div>
                        <div class="flex justify-between pt-2 border-t border-gray-800">
                            <span class="text-gray-500 text-sm">ROI Status:</span>
                            <span class="text-yellow-500 font-mono text-sm">Active</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gray-900 p-5 rounded-xl border border-gray-800">
                    <h3 class="text-gray-400 text-xs font-bold uppercase mb-2">Detection Rules</h3>
                    <p class="text-xs text-gray-500 leading-relaxed italic">
                        "If a hand enters the Protein ROI and interacts with a Pizza without a Scooper, a violation is logged."
                    </p>
                </div>
            </div>
        </div>

        <section class="mt-8 bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden shadow-2xl">
            <div class="bg-gray-800/50 px-6 py-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span class="text-red-500">üî¥</span> Recent Violations Snapshots
                </h3>
                <span class="text-xs text-gray-500 italic uppercase">Auto-updating log</span>
            </div>
            
            <div id="log-container" class="flex flex-row gap-6 p-6 overflow-x-auto min-h-[220px] items-center">
                <div id="no-violations" class="w-full text-center py-10">
                    <p class="text-gray-600 italic">Waiting for detection data...</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        const canvas = document.getElementById('video-canvas');
        const ctx = canvas.getContext('2d');
        const violationCountDisp = document.getElementById('violation-count');
        const alertBox = document.getElementById('violation-alert');
        const statusText = document.getElementById('status-text');
        const statusDot = document.getElementById('status-dot');
        const objCountDisp = document.getElementById('obj-count');
        const logContainer = document.getElementById('log-container');
        const noViolationsMsg = document.getElementById('no-violations');
        
        let ws;

        document.getElementById('start-btn').onclick = connectWS;
        document.getElementById('stop-btn').onclick = () => {
            if(ws) ws.close();
            updateStatus(false);
        };

        function updateStatus(online) {
            statusText.innerText = online ? "Live Stream" : "Offline";
            statusText.className = online ? "text-green-500 text-sm font-medium" : "text-gray-500 text-sm font-medium";
            statusDot.className = online ? "w-3 h-3 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]" : "w-3 h-3 bg-gray-600 rounded-full";
        }

        function addToLog(frameBase64) {
            if (noViolationsMsg) noViolationsMsg.remove();

            const time = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = "log-card flex-none w-52 bg-gray-800 rounded-xl overflow-hidden border border-red-900/50 hover:border-red-500 shadow-lg";
            
            logEntry.innerHTML = `
                <img src="data:image/jpeg;base64,${frameBase64}" class="w-full h-32 object-cover border-b border-gray-700">
                <div class="p-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] text-gray-500 font-bold">${time}</span>
                        <span class="text-[10px] bg-red-900/30 text-red-400 px-2 py-0.5 rounded">SCOOPER MISSING</span>
                    </div>
                    <p class="text-xs text-gray-300">Violation Detected at ROI</p>
                </div>
            `;
            
            logContainer.prepend(logEntry);
        }

        function connectWS() {
            ws = new WebSocket("ws://127.0.0.1:8000/ws");
            
            ws.onopen = () => updateStatus(true);
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                // 1. Update Stats
                violationCountDisp.innerText = data.violations;
                objCountDisp.innerText = data.boxes.length;

                // 2. Handle Violation
                if(data.violation) {
                    alertBox.classList.remove('hidden');
                    addToLog(data.frame);
                    setTimeout(() => alertBox.classList.add('hidden'), 1200);
                }

                // 3. Draw Frame & Annotations
                const image = new Image();
                image.onload = () => {
                    canvas.width = image.width;
                    canvas.height = image.height;
                    ctx.drawImage(image, 0, 0);

                    // Draw ROI
                    ctx.strokeStyle = "rgba(239, 68, 68, 0.7)";
                    ctx.setLineDash([8, 4]);
                    ctx.lineWidth = 4;
                    ctx.strokeRect(data.roi.x1, data.roi.y1, data.roi.x2 - data.roi.x1, data.roi.y2 - data.roi.y1);
                    ctx.setLineDash([]);

                    // Draw Detections
                    data.boxes.forEach(box => {
                        const isScooper = box.label.toLowerCase() === "scooper";
                        ctx.strokeStyle = isScooper ? "#3b82f6" : "#10b981";
                        ctx.lineWidth = 3;
                        ctx.strokeRect(box.x1, box.y1, box.x2 - box.x1, box.y2 - box.y1);
                        
                        // Label
                        ctx.fillStyle = isScooper ? "#3b82f6" : "#10b981";
                        const labelWidth = ctx.measureText(box.label).width;
                        ctx.fillRect(box.x1 - 1, box.y1 - 25, labelWidth + 20, 25);
                        ctx.fillStyle = "white";
                        ctx.font = "bold 14px sans-serif";
                        ctx.fillText(box.label.toUpperCase(), box.x1 + 5, box.y1 - 7);
                    });
                };
                image.src = "data:image/jpeg;base64," + data.frame;
            };

            ws.onclose = () => updateStatus(false);
            ws.onerror = () => updateStatus(false);
        }
    </script>
</body>
</html>